description: "Create an stunnel connection"
parameters:
  stunnel_host:
    default: "STUNNEL_HOST"
    type: string
    description: The environment variable storing the host to be connecting to
  stunnel_host_port:
    default: "STUNNEL_HOST_PORT"
    type: string
    description: The environment variable storing the port of the host to connecting via
  accept_port:
    default: "STUNNEL_ACCEPT_PORT"
    type: string
    description: The environment variable storing the stunnel accept port
  preshared_key:
    default: "STUNNEL_PSK"
    type: string
    description: The environment variable storing the stunnel preshared key
  target_host:
    type: string
    description: Name of the host to connect to through stunnel
steps:
  - run:
      name: "[security/core] [Install] curl, sudo"
      command: |
        if [[ ! $(which curl) ]]; then
          (set +o pipefail; apk add curl || apt-get install -y curl || yum install -y curl)
        fi
        if [[ ! $(which sudo) ]]; then
          (set +o pipefail; apk add sudo || apt-get install -y sudo || yum install -y sudo)
        fi
  - run:
      name: "[security/stunnel] [Install] stunnel"
      command: |
        sudo apt update
        sudo apt install -y stunnel4
  - run:
      name: "[security/stunnel] [Prepare] stunnel configuration"
      command: |
        sudo curl -sL https://github.com/itsdean/circleci-security/raw/master/stunnel.conf > /tmp/stunnel.conf
        sudo mv /tmp/stunnel.conf /etc/stunnel/
        sudo chown root:root /etc/stunnel/stunnel.conf
        sudo chmod 600 /etc/stunnel/stunnel.conf

        sudo sed -i 's/STUNNEL_PROCESS_FG/'${STUNNEL_PROCESS_FG}'/g' /etc/stunnel/stunnel.conf
        sudo sed -i 's/STUNNEL_ACCEPT_PORT/'${<< parameters.accept_port >>}'/g' /etc/stunnel/stunnel.conf
        sudo sed -i 's/STUNNEL_HOST/'${<< parameters.stunnel_host >>}'/g' /etc/stunnel/stunnel.conf
        sudo sed -i 's/STUNNEL_CONNECT_PORT/'${<< parameters.stunnel_host_port >>}'/g' /etc/stunnel/stunnel.conf

        echo $<< parameters.preshared_key >> | sudo tee /etc/stunnel/psk.txt
        sudo chown root:root /etc/stunnel/psk.txt
        sudo chmod 600 /etc/stunnel/psk.txt
  - when:
      condition: << parameters.target_host >>
      steps:
      - run:
          name: "[security/stunnel] [Prepare] Target hostname"
          command: |
            echo "127.0.0.1 << parameters.target_host >>" | sudo tee -a /etc/hosts
  - run:
      name: "[security/stunnel] [Run] stunnel"
      command: |
        sudo /usr/bin/stunnel /etc/stunnel/stunnel.conf
